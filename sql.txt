WITH RECURSIVE column_relations AS (
    -- 起点：获取给定表名对应表的所有列（源列）
    SELECT 
        t.id AS source_table_id,
        l.name AS source_layer,
        t.name AS source_table_name,
        c.name AS source_column_name,
        NULL::int AS target_column_id,
        NULL::varchar AS target_table_name,
        NULL::varchar AS target_layer,
        'START' AS relation_direction
    FROM 
        meta_entity_table t
    JOIN 
        meta_entity_layer l ON t.layer_id = l.id  -- 关联层信息
    JOIN 
        meta_entity_table_column c ON t.id = c.table_id
    WHERE 
        t.name = 'my_table'  -- 输入的表名

    UNION ALL

    -- 向下递归查找下游列
    SELECT 
        t_source.id AS source_table_id,
        l_source.name AS source_layer,
        t_source.name AS source_table_name,
        c_source.name AS source_column_name,
        c_target.id AS target_column_id,
        t_target.name AS target_table_name,
        l_target.name AS target_layer,
        'DOWNSTREAM' AS relation_direction
    FROM 
        meta_entity_transition tr
    JOIN 
        meta_entity_table_column c_source ON tr.source_id = c_source.id  -- 源列
    JOIN 
        meta_entity_table t_source ON c_source.table_id = t_source.id  -- 源表
    JOIN 
        meta_entity_layer l_source ON t_source.layer_id = l_source.id  -- 源表对应的层

    JOIN 
        meta_entity_table_column c_target ON tr.target_id = c_target.id  -- 目标列
    JOIN 
        meta_entity_table t_target ON c_target.table_id = t_target.id  -- 目标表
    JOIN 
        meta_entity_layer l_target ON t_target.layer_id = l_target.id  -- 目标表对应的层

    JOIN 
        column_relations cr ON tr.source_id = cr.target_column_id  -- 递归查找

    UNION ALL

    -- 向上递归查找上游列
    SELECT 
        t_target.id AS source_table_id,
        l_target.name AS source_layer,
        t_target.name AS source_table_name,
        c_target.name AS source_column_name,
        c_source.id AS target_column_id,
        t_source.name AS target_table_name,
        l_source.name AS target_layer,
        'UPSTREAM' AS relation_direction
    FROM 
        meta_entity_transition tr
    JOIN 
        meta_entity_table_column c_source ON tr.source_id = c_source.id  -- 源列
    JOIN 
        meta_entity_table t_source ON c_source.table_id = t_source.id  -- 源表
    JOIN 
        meta_entity_layer l_source ON t_source.layer_id = l_source.id  -- 源表对应的层

    JOIN 
        meta_entity_table_column c_target ON tr.target_id = c_target.id  -- 目标列
    JOIN 
        meta_entity_table t_target ON c_target.table_id = t_target.id  -- 目标表
    JOIN 
        meta_entity_layer l_target ON t_target.layer_id = l_target.id  -- 目标表对应的层

    JOIN 
        column_relations cr ON tr.target_id = cr.source_table_id -- 递归查找
)

-- 最终查询结果，排除起点
SELECT DISTINCT 
    cr.source_layer,
    cr.source_table_name,
    cr.source_column_name,
    cr.target_layer,
    cr.target_table_name,
    cr.target_column_name
FROM 
    column_relations cr
WHERE 
    cr.relation_direction != 'START';